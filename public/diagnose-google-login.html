<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google 登入問題診斷</title>
  <style>
    body {
      font-family: 'Microsoft JhengHei', Arial, sans-serif;
      max-width: 900px;
      margin: 30px auto;
      padding: 20px;
      background: #f5f7fa;
    }
    .header {
      background: linear-gradient(135deg, #1a3a6e 0%, #2a4a7e 100%);
      color: white;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
    }
    .card {
      background: white;
      padding: 25px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .step {
      background: #f8f9fa;
      padding: 20px;
      margin: 15px 0;
      border-left: 4px solid #1a3a6e;
      border-radius: 4px;
    }
    .step h3 {
      margin-top: 0;
      color: #1a3a6e;
    }
    .alert {
      padding: 15px;
      margin: 15px 0;
      border-radius: 6px;
      border-left: 4px solid;
    }
    .alert-success {
      background: #d4edda;
      border-color: #28a745;
      color: #155724;
    }
    .alert-error {
      background: #f8d7da;
      border-color: #dc3545;
      color: #721c24;
    }
    .alert-warning {
      background: #fff3cd;
      border-color: #ffc107;
      color: #856404;
    }
    .alert-info {
      background: #d1ecf1;
      border-color: #17a2b8;
      color: #0c5460;
    }
    button {
      background: #1a3a6e;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
      transition: all 0.3s;
    }
    button:hover {
      background: #2a4a7e;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      color: #d73a49;
    }
    pre {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 13px;
    }
    .checklist {
      list-style: none;
      padding: 0;
    }
    .checklist li {
      padding: 10px;
      margin: 8px 0;
      background: #f8f9fa;
      border-radius: 4px;
      position: relative;
      padding-left: 40px;
    }
    .checklist li:before {
      content: '□';
      position: absolute;
      left: 15px;
      font-size: 20px;
      color: #1a3a6e;
    }
    .link-button {
      display: inline-block;
      background: #17a2b8;
      color: white;
      padding: 10px 20px;
      text-decoration: none;
      border-radius: 6px;
      margin: 5px;
      transition: all 0.3s;
    }
    .link-button:hover {
      background: #138496;
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>🔍 Google 登入問題診斷工具</h1>
    <p>用於診斷「清除 cookies 後用 Google 登入會進入註冊頁面」的問題</p>
  </div>

  <div class="card">
    <h2>📋 問題描述</h2>
    <div class="alert alert-error">
      <strong>用戶報告：</strong>
      <ol>
        <li>清除 cookies 後用 Google 登入會進入註冊頁面</li>
        <li>填完送出會顯示錯誤</li>
        <li>直接用信箱註冊會顯示「信箱已註冊」</li>
      </ol>
    </div>
  </div>

  <div class="card">
    <h2>✅ 已實施的修復</h2>
    <div class="alert alert-success">
      <strong>修復內容（提交 9710c3e）：</strong>
      <p>在 <code>/api/userinfo</code> 中添加自動遷移邏輯：</p>
      <ul>
        <li>當通過 UID 找不到用戶時，自動通過 email 查找</li>
        <li>如果找到相同 email 的用戶，自動將資料遷移到新 UID</li>
        <li>支持 Email/Password ↔ Google 之間的無縫切換</li>
      </ul>
    </div>
  </div>

  <div class="card">
    <h2>🧪 測試步驟</h2>
    
    <div class="step">
      <h3>步驟 1: 準備測試環境</h3>
      <ul class="checklist">
        <li>確認已部署最新版本（提交 9710c3e 或更新）</li>
        <li>準備一個已註冊的 Email（例如：test@example.com）</li>
        <li>確保該 Email 有對應的 Google 帳號</li>
      </ul>
    </div>

    <div class="step">
      <h3>步驟 2: 清除所有數據</h3>
      <div class="alert alert-warning">
        <strong>重要：</strong>必須完全清除瀏覽器數據才能重現問題
      </div>
      <ol>
        <li>打開 Chrome DevTools（F12）</li>
        <li>Application → Storage → Clear site data</li>
        <li>確保勾選：
          <ul>
            <li>✅ Cookies and other site data</li>
            <li>✅ Cache storage</li>
            <li>✅ Local storage</li>
            <li>✅ Session storage</li>
          </ul>
        </li>
        <li>點擊「Clear site data」</li>
        <li>重新整理頁面</li>
      </ol>
    </div>

    <div class="step">
      <h3>步驟 3: 測試 Google 登入</h3>
      <a href="/auth" class="link-button" target="_blank">前往登入頁面 →</a>
      <ol>
        <li>點擊「Google 登入」按鈕</li>
        <li>選擇您的 Google 帳號（使用已註冊的 email）</li>
        <li>觀察頁面跳轉行為</li>
      </ol>
    </div>

    <div class="step">
      <h3>步驟 4: 觀察結果</h3>
      <div class="alert alert-info">
        <strong>預期結果（修復後）：</strong>
        <ul>
          <li>✅ 直接跳轉到 <code>/profile</code> 頁面</li>
          <li>✅ 顯示您的個人資料</li>
          <li>✅ 右上角顯示您的頭像</li>
          <li>✅ Console 顯示：<code>[/api/userinfo] Found existing user by email, migrating...</code></li>
        </ul>
      </div>
      <div class="alert alert-error">
        <strong>如果仍有問題：</strong>
        <ul>
          <li>❌ 跳轉到 <code>/register</code> 頁面</li>
          <li>❌ 要求填寫註冊表單</li>
          <li>❌ 提交後顯示錯誤</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>🔧 診斷工具</h2>
    
    <div class="step">
      <h3>檢查 Console 日誌</h3>
      <p>打開 Chrome DevTools → Console，查找以下關鍵日誌：</p>
      <pre>
<span style="color: #50fa7b;">[AuthContext]</span> User data fetched successfully
<span style="color: #50fa7b;">[/api/userinfo]</span> User not found by UID, trying to find by email...
<span style="color: #50fa7b;">[/api/userinfo]</span> Searching for email: xxx@gmail.com
<span style="color: #50fa7b;">[/api/userinfo]</span> Found existing user by email, migrating to new UID...
<span style="color: #50fa7b;">[/api/userinfo]</span> ✅ User data migrated successfully</pre>
    </div>

    <div class="step">
      <h3>檢查 Network 請求</h3>
      <p>打開 Chrome DevTools → Network，查找 <code>/api/userinfo</code> 請求：</p>
      <ol>
        <li>狀態碼應該是 <strong>200 OK</strong>（不是 404）</li>
        <li>Response 應包含完整的用戶資料</li>
        <li>如果是 404，表示遷移失敗</li>
      </ol>
    </div>

    <div class="step">
      <h3>檢查重定向</h3>
      <p>觀察頁面跳轉順序：</p>
      <ul>
        <li>✅ <code>/auth</code> → <code>/profile</code>（正確）</li>
        <li>❌ <code>/auth</code> → <code>/register</code>（錯誤）</li>
      </ul>
    </div>
  </div>

  <div class="card">
    <h2>🐛 如果問題仍然存在</h2>
    
    <div class="alert alert-warning">
      <strong>請提供以下資訊：</strong>
      <ol>
        <li><strong>Console 完整日誌：</strong>
          <ul>
            <li>右鍵點擊 Console → Save as...</li>
            <li>或截圖所有 <code>[AuthContext]</code> 和 <code>[/api/userinfo]</code> 相關日誌</li>
          </ul>
        </li>
        <li><strong>Network 面板截圖：</strong>
          <ul>
            <li>過濾：<code>/api/userinfo</code></li>
            <li>截圖 Request Headers、Response</li>
          </ul>
        </li>
        <li><strong>錯誤訊息：</strong>
          <ul>
            <li>註冊頁面提交時的具體錯誤訊息</li>
            <li>Alert 彈窗內容</li>
          </ul>
        </li>
        <li><strong>測試環境：</strong>
          <ul>
            <li>使用的網址（localhost:3009 或 hackathon.com.tw）</li>
            <li>測試的 Email（可以模糊處理）</li>
            <li>是否是第一次用 Google 登入這個網站</li>
          </ul>
        </li>
      </ol>
    </div>
  </div>

  <div class="card">
    <h2>📞 快速測試連結</h2>
    <div style="text-align: center; padding: 20px;">
      <a href="/auth" class="link-button" target="_blank">🔐 登入頁面</a>
      <a href="/register" class="link-button" target="_blank">📝 註冊頁面</a>
      <a href="/profile" class="link-button" target="_blank">👤 個人頁面</a>
    </div>
  </div>

  <div class="card">
    <h2>💡 技術說明</h2>
    <details>
      <summary style="cursor: pointer; color: #1a3a6e; font-weight: bold;">點擊查看修復的技術細節</summary>
      <div style="margin-top: 15px;">
        <h3>問題根本原因：</h3>
        <p>Firebase Authentication 對不同登入方式使用不同的 UID：</p>
        <ul>
          <li>Email/Password 登入：UID_1</li>
          <li>Google 登入（相同 email）：UID_2</li>
        </ul>
        <p>原本的系統只通過 UID 查找用戶，導致找不到資料。</p>

        <h3>修復方案：</h3>
        <p>在 <code>pages/api/userinfo.tsx</code> 中添加邏輯：</p>
        <pre style="font-size: 12px;">
// 1. 嘗試通過 UID 查找
let snapshot = await db.collection('registrations').doc(userID).get();

if (!snapshot.exists) {
  // 2. 獲取 email from token
  const payload = await auth().verifyIdToken(userToken);
  const userEmail = payload.email;
  
  // 3. 通過 email 查找現有用戶
  const emailQuery = await db.collection('registrations')
    .where('email', '==', userEmail)
    .get();
  
  if (!emailQuery.empty) {
    // 4. 自動遷移資料到新 UID
    await db.collection('registrations').doc(userID).set({
      ...existingData,
      id: userID,
      migratedFrom: oldUID,
    });
  }
}</pre>
      </div>
    </details>
  </div>

  <script>
    // 添加交互功能
    document.querySelectorAll('.checklist li').forEach(item => {
      item.style.cursor = 'pointer';
      item.addEventListener('click', function() {
        if (this.style.textDecoration === 'line-through') {
          this.style.textDecoration = 'none';
          this.style.opacity = '1';
          this.querySelector(':before').content = '□';
        } else {
          this.style.textDecoration = 'line-through';
          this.style.opacity = '0.6';
        }
      });
    });
  </script>
</body>
</html>

