<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>測試 Google 登入流程</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      line-height: 1.6;
    }
    .section {
      background: #f5f5f5;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
    }
    .step {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-left: 4px solid #1a3a6e;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    button {
      background: #1a3a6e;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover { background: #2a4a7e; }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    pre {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>🔍 測試 Google 登入與註冊流程</h1>
  
  <div class="section">
    <h2>測試說明</h2>
    <p>這個測試頁面用於驗證以下場景：</p>
    <ol>
      <li>用戶之前用 Email/Password 註冊</li>
      <li>清除 Cookies 後用 Google 登入（相同 email）</li>
      <li>系統是否能正確識別並自動遷移用戶資料</li>
    </ol>
  </div>

  <div class="section">
    <h2>測試步驟</h2>
    
    <div class="step">
      <h3>步驟 1: 輸入測試 Email</h3>
      <input type="email" id="testEmail" placeholder="輸入要測試的 email" style="width: 100%; padding: 8px;">
    </div>

    <div class="step">
      <h3>步驟 2: 檢查此 Email 是否已註冊</h3>
      <button onclick="checkEmailExists()">檢查 Email</button>
      <div id="emailCheckResult"></div>
    </div>

    <div class="step">
      <h3>步驟 3: 模擬 Google 登入後的 API 調用</h3>
      <p class="info">這會模擬 AuthContext 在 Google 登入後調用 /api/userinfo 的情況</p>
      <button onclick="simulateGoogleLogin()" id="simulateBtn" disabled>模擬 Google 登入</button>
      <div id="simulateResult"></div>
    </div>

    <div class="step">
      <h3>步驟 4: 驗證遷移結果</h3>
      <button onclick="verifyMigration()" id="verifyBtn" disabled>驗證遷移</button>
      <div id="verifyResult"></div>
    </div>
  </div>

  <div class="section">
    <h2>測試日誌</h2>
    <pre id="logOutput"></pre>
  </div>

  <script>
    let testData = {
      email: '',
      oldUid: null,
      newUid: null,
      oldData: null
    };

    function log(message, type = 'info') {
      const logOutput = document.getElementById('logOutput');
      const timestamp = new Date().toLocaleTimeString();
      const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️';
      logOutput.textContent += `[${timestamp}] ${icon} ${message}\n`;
      logOutput.scrollTop = logOutput.scrollHeight;
    }

    function showResult(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    async function checkEmailExists() {
      const email = document.getElementById('testEmail').value.trim();
      if (!email) {
        alert('請輸入 email');
        return;
      }

      testData.email = email;
      log(`檢查 email: ${email}`);

      try {
        // 這裡需要實際的 API 調用來檢查 email 是否存在
        // 由於安全限制，我們無法直接從前端查詢 Firestore
        showResult('emailCheckResult', 
          `請手動確認此 email 是否已在系統中註冊。\n` +
          `如果已註冊，請記下對應的 UID，然後繼續測試。`, 
          'info'
        );
        
        log(`✓ Email 檢查完成: ${email}`);
        document.getElementById('simulateBtn').disabled = false;

      } catch (error) {
        log(`檢查失敗: ${error.message}`, 'error');
        showResult('emailCheckResult', `錯誤: ${error.message}`, 'error');
      }
    }

    async function simulateGoogleLogin() {
      log(`模擬 Google 登入流程...`);
      
      showResult('simulateResult', 
        `<h4>測試說明：</h4>
        <p>實際測試步驟：</p>
        <ol>
          <li>清除所有 Cookies（DevTools → Application → Clear site data）</li>
          <li>訪問 <a href="/auth" target="_blank">/auth</a> 頁面</li>
          <li>點擊 Google 登入按鈕</li>
          <li>使用測試的 Google 帳號登入（email: ${testData.email}）</li>
          <li>觀察是否直接進入個人頁面，還是進入註冊頁面</li>
        </ol>
        <h4>預期結果：</h4>
        <p class="success">✅ 如果之前用此 email 註冊過，應該自動識別並登入成功，不應進入註冊頁面</p>
        <p class="error">❌ 如果進入註冊頁面，表示自動遷移失敗</p>`, 
        'info'
      );

      log(`✓ 測試說明已顯示`);
      document.getElementById('verifyBtn').disabled = false;
    }

    async function verifyMigration() {
      log(`驗證遷移結果...`);
      
      showResult('verifyResult', 
        `<h4>手動驗證步驟：</h4>
        <ol>
          <li>檢查瀏覽器控制台的 console.log 輸出</li>
          <li>查找 <code>[AuthContext]</code> 相關的日誌</li>
          <li>確認是否看到 <code>[/api/userinfo] Found existing user by email, migrating...</code></li>
          <li>確認是否成功進入個人頁面（/profile）</li>
        </ol>
        <h4>如果遷移失敗：</h4>
        <p>請截圖以下資訊並提供給開發者：</p>
        <ul>
          <li>瀏覽器控制台的完整錯誤訊息</li>
          <li>Network 面板中 /api/userinfo 的 Request/Response</li>
          <li>註冊頁面提交時的錯誤訊息</li>
        </ul>`, 
        'info'
      );

      log(`✓ 驗證說明已顯示`);
    }
  </script>
</body>
</html>

