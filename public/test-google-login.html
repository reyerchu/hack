<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¸¬è©¦ Google ç™»å…¥æµç¨‹</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      line-height: 1.6;
    }
    .section {
      background: #f5f5f5;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
    }
    .step {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-left: 4px solid #1a3a6e;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    button {
      background: #1a3a6e;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover { background: #2a4a7e; }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    pre {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>ğŸ” æ¸¬è©¦ Google ç™»å…¥èˆ‡è¨»å†Šæµç¨‹</h1>
  
  <div class="section">
    <h2>æ¸¬è©¦èªªæ˜</h2>
    <p>é€™å€‹æ¸¬è©¦é é¢ç”¨æ–¼é©—è­‰ä»¥ä¸‹å ´æ™¯ï¼š</p>
    <ol>
      <li>ç”¨æˆ¶ä¹‹å‰ç”¨ Email/Password è¨»å†Š</li>
      <li>æ¸…é™¤ Cookies å¾Œç”¨ Google ç™»å…¥ï¼ˆç›¸åŒ emailï¼‰</li>
      <li>ç³»çµ±æ˜¯å¦èƒ½æ­£ç¢ºè­˜åˆ¥ä¸¦è‡ªå‹•é·ç§»ç”¨æˆ¶è³‡æ–™</li>
    </ol>
  </div>

  <div class="section">
    <h2>æ¸¬è©¦æ­¥é©Ÿ</h2>
    
    <div class="step">
      <h3>æ­¥é©Ÿ 1: è¼¸å…¥æ¸¬è©¦ Email</h3>
      <input type="email" id="testEmail" placeholder="è¼¸å…¥è¦æ¸¬è©¦çš„ email" style="width: 100%; padding: 8px;">
    </div>

    <div class="step">
      <h3>æ­¥é©Ÿ 2: æª¢æŸ¥æ­¤ Email æ˜¯å¦å·²è¨»å†Š</h3>
      <button onclick="checkEmailExists()">æª¢æŸ¥ Email</button>
      <div id="emailCheckResult"></div>
    </div>

    <div class="step">
      <h3>æ­¥é©Ÿ 3: æ¨¡æ“¬ Google ç™»å…¥å¾Œçš„ API èª¿ç”¨</h3>
      <p class="info">é€™æœƒæ¨¡æ“¬ AuthContext åœ¨ Google ç™»å…¥å¾Œèª¿ç”¨ /api/userinfo çš„æƒ…æ³</p>
      <button onclick="simulateGoogleLogin()" id="simulateBtn" disabled>æ¨¡æ“¬ Google ç™»å…¥</button>
      <div id="simulateResult"></div>
    </div>

    <div class="step">
      <h3>æ­¥é©Ÿ 4: é©—è­‰é·ç§»çµæœ</h3>
      <button onclick="verifyMigration()" id="verifyBtn" disabled>é©—è­‰é·ç§»</button>
      <div id="verifyResult"></div>
    </div>
  </div>

  <div class="section">
    <h2>æ¸¬è©¦æ—¥èªŒ</h2>
    <pre id="logOutput"></pre>
  </div>

  <script>
    let testData = {
      email: '',
      oldUid: null,
      newUid: null,
      oldData: null
    };

    function log(message, type = 'info') {
      const logOutput = document.getElementById('logOutput');
      const timestamp = new Date().toLocaleTimeString();
      const icon = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸';
      logOutput.textContent += `[${timestamp}] ${icon} ${message}\n`;
      logOutput.scrollTop = logOutput.scrollHeight;
    }

    function showResult(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    async function checkEmailExists() {
      const email = document.getElementById('testEmail').value.trim();
      if (!email) {
        alert('è«‹è¼¸å…¥ email');
        return;
      }

      testData.email = email;
      log(`æª¢æŸ¥ email: ${email}`);

      try {
        // é€™è£¡éœ€è¦å¯¦éš›çš„ API èª¿ç”¨ä¾†æª¢æŸ¥ email æ˜¯å¦å­˜åœ¨
        // ç”±æ–¼å®‰å…¨é™åˆ¶ï¼Œæˆ‘å€‘ç„¡æ³•ç›´æ¥å¾å‰ç«¯æŸ¥è©¢ Firestore
        showResult('emailCheckResult', 
          `è«‹æ‰‹å‹•ç¢ºèªæ­¤ email æ˜¯å¦å·²åœ¨ç³»çµ±ä¸­è¨»å†Šã€‚\n` +
          `å¦‚æœå·²è¨»å†Šï¼Œè«‹è¨˜ä¸‹å°æ‡‰çš„ UIDï¼Œç„¶å¾Œç¹¼çºŒæ¸¬è©¦ã€‚`, 
          'info'
        );
        
        log(`âœ“ Email æª¢æŸ¥å®Œæˆ: ${email}`);
        document.getElementById('simulateBtn').disabled = false;

      } catch (error) {
        log(`æª¢æŸ¥å¤±æ•—: ${error.message}`, 'error');
        showResult('emailCheckResult', `éŒ¯èª¤: ${error.message}`, 'error');
      }
    }

    async function simulateGoogleLogin() {
      log(`æ¨¡æ“¬ Google ç™»å…¥æµç¨‹...`);
      
      showResult('simulateResult', 
        `<h4>æ¸¬è©¦èªªæ˜ï¼š</h4>
        <p>å¯¦éš›æ¸¬è©¦æ­¥é©Ÿï¼š</p>
        <ol>
          <li>æ¸…é™¤æ‰€æœ‰ Cookiesï¼ˆDevTools â†’ Application â†’ Clear site dataï¼‰</li>
          <li>è¨ªå• <a href="/auth" target="_blank">/auth</a> é é¢</li>
          <li>é»æ“Š Google ç™»å…¥æŒ‰éˆ•</li>
          <li>ä½¿ç”¨æ¸¬è©¦çš„ Google å¸³è™Ÿç™»å…¥ï¼ˆemail: ${testData.email}ï¼‰</li>
          <li>è§€å¯Ÿæ˜¯å¦ç›´æ¥é€²å…¥å€‹äººé é¢ï¼Œé‚„æ˜¯é€²å…¥è¨»å†Šé é¢</li>
        </ol>
        <h4>é æœŸçµæœï¼š</h4>
        <p class="success">âœ… å¦‚æœä¹‹å‰ç”¨æ­¤ email è¨»å†Šéï¼Œæ‡‰è©²è‡ªå‹•è­˜åˆ¥ä¸¦ç™»å…¥æˆåŠŸï¼Œä¸æ‡‰é€²å…¥è¨»å†Šé é¢</p>
        <p class="error">âŒ å¦‚æœé€²å…¥è¨»å†Šé é¢ï¼Œè¡¨ç¤ºè‡ªå‹•é·ç§»å¤±æ•—</p>`, 
        'info'
      );

      log(`âœ“ æ¸¬è©¦èªªæ˜å·²é¡¯ç¤º`);
      document.getElementById('verifyBtn').disabled = false;
    }

    async function verifyMigration() {
      log(`é©—è­‰é·ç§»çµæœ...`);
      
      showResult('verifyResult', 
        `<h4>æ‰‹å‹•é©—è­‰æ­¥é©Ÿï¼š</h4>
        <ol>
          <li>æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°çš„ console.log è¼¸å‡º</li>
          <li>æŸ¥æ‰¾ <code>[AuthContext]</code> ç›¸é—œçš„æ—¥èªŒ</li>
          <li>ç¢ºèªæ˜¯å¦çœ‹åˆ° <code>[/api/userinfo] Found existing user by email, migrating...</code></li>
          <li>ç¢ºèªæ˜¯å¦æˆåŠŸé€²å…¥å€‹äººé é¢ï¼ˆ/profileï¼‰</li>
        </ol>
        <h4>å¦‚æœé·ç§»å¤±æ•—ï¼š</h4>
        <p>è«‹æˆªåœ–ä»¥ä¸‹è³‡è¨Šä¸¦æä¾›çµ¦é–‹ç™¼è€…ï¼š</p>
        <ul>
          <li>ç€è¦½å™¨æ§åˆ¶å°çš„å®Œæ•´éŒ¯èª¤è¨Šæ¯</li>
          <li>Network é¢æ¿ä¸­ /api/userinfo çš„ Request/Response</li>
          <li>è¨»å†Šé é¢æäº¤æ™‚çš„éŒ¯èª¤è¨Šæ¯</li>
        </ul>`, 
        'info'
      );

      log(`âœ“ é©—è­‰èªªæ˜å·²é¡¯ç¤º`);
    }
  </script>
</body>
</html>

