# NFT 系統流程圖

## 整體架構流程

```
┌─────────────────────────────────────────────────────────────────┐
│                         用戶入口                                  │
├──────────────┬───────────────────┬──────────────────────────────┤
│              │                   │                              │
│   管理員      │      用戶          │         訪客                  │
│ (super_admin) │   (登入用戶)       │      (任何人)                 │
│              │                   │                              │
└──────┬───────┴────────┬──────────┴──────────┬───────────────────┘
       │                │                     │
       ▼                ▼                     ▼
┌──────────────┐ ┌──────────────┐  ┌──────────────────┐
│ 創建活動      │ │ 查看資格      │  │ 查看公開頁面      │
│ 部署合約      │ │ 鑄造 NFT      │  │ 瀏覽鑄造記錄      │
│ 管理白名單    │ │ 查看已鑄造    │  │ 分享連結          │
└──────────────┘ └──────────────┘  └──────────────────┘
```

## 管理員創建 NFT 活動流程

```
開始
  │
  ▼
┌─────────────────────────────────────┐
│ 1. 訪問管理員頁面                     │
│    /admin/nft/campaigns              │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│ 2. 點擊「建立新活動」                 │
│    填寫活動資訊：                     │
│    • 名稱、描述                       │
│    • 上傳圖片                         │
│    • 選擇網路                         │
│    • 設定供應量                       │
│    • 輸入白名單 email                 │
│    • 設定截止日期                     │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│ 3. 點擊「建立活動」                   │
│    ↓                                 │
│    活動記錄已創建（狀態：draft）       │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│ 4. 點擊「自動設置」                   │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│ 5. IPFS 上傳                         │
│    ⏳ 正在上傳到 IPFS...              │
│    ↓                                 │
│    • 上傳 NFT 圖片                   │
│    • 生成 metadata JSON              │
│    • 上傳 metadata                   │
│    • 獲得 Base URI                   │
│    ↓                                 │
│    ✅ IPFS 上傳完成                  │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│ 6. 連接錢包                          │
│    🔗 請連接錢包                     │
│    [連接 MetaMask]                   │
│    ↓                                 │
│    (用戶在 MetaMask 點擊「連接」)    │
│    ↓                                 │
│    ✅ 錢包已連接                     │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│ 7. 部署智能合約                       │
│    📝 正在部署合約...                 │
│    ↓                                 │
│    (MetaMask 彈出交易確認)           │
│    ↓                                 │
│    [用戶點擊「確認」]                 │
│    ↓                                 │
│    ⏳ 等待區塊鏈確認...               │
│    ↓                                 │
│    ✅ 合約部署完成                   │
│    合約地址：0x...                   │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│ 8. 設置 Merkle Tree 白名單           │
│    🌳 正在設置白名單...               │
│    ↓                                 │
│    • 計算每個 email 的 hash          │
│    • 生成 Merkle Tree                │
│    • 計算 Merkle Proofs              │
│    ↓                                 │
│    (MetaMask 彈出交易確認)           │
│    ↓                                 │
│    [用戶點擊「確認」]                 │
│    ↓                                 │
│    ✅ 白名單設置完成                 │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│ 9. 啟用鑄造                          │
│    🎉 正在啟用鑄造...                 │
│    ↓                                 │
│    (MetaMask 彈出交易確認)           │
│    ↓                                 │
│    [用戶點擊「確認」]                 │
│    ↓                                 │
│    ✅ 鑄造已啟用                     │
│    活動狀態：active                  │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│ ✅ 設置完成！                         │
│    用戶現在可以開始鑄造 NFT           │
└─────────────────────────────────────┘
```

## 用戶鑄造 NFT 流程

```
開始
  │
  ▼
┌─────────────────────────────────────┐
│ 1. 用戶登入系統                       │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│ 2. 訪問個人頁面                       │
│    /user/[userId]                    │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│ 3. 查看「NFT 紀念品」區域             │
│    ↓                                 │
│    顯示所有相關的 NFT 活動：          │
│    • ✅ 符合資格 → [鑄造 NFT]        │
│    • ✅ 已鑄造 → 顯示「已鑄造」       │
│    • ❌ 不符合 → 顯示原因            │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│ 4. 點擊「鑄造 NFT」                   │
│    ↓                                 │
│    跳轉到鑄造頁面                     │
│    /nft/mint?campaign=xxx            │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│ 5. 連接錢包                          │
│    [連接錢包]                         │
│    ↓                                 │
│    (MetaMask 彈出授權)               │
│    ↓                                 │
│    [用戶點擊「連接」]                 │
│    ↓                                 │
│    ✅ 錢包已連接                     │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│ 6. 檢查並切換網路（如需要）           │
│    ⚠️ 請切換到 Sepolia 網路          │
│    [切換網路]                         │
│    ↓                                 │
│    (MetaMask 彈出切換請求)           │
│    ↓                                 │
│    [用戶點擊「切換網路」]             │
│    ↓                                 │
│    ✅ 網路已切換                     │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│ 7. 鑄造 NFT                          │
│    [鑄造 NFT]                         │
│    ↓                                 │
│    系統獲取 Merkle Proof             │
│    ↓                                 │
│    呼叫智能合約 mint() 函數          │
│    ↓                                 │
│    (MetaMask 彈出交易確認)           │
│    顯示 gas 費用                     │
│    ↓                                 │
│    [用戶點擊「確認」]                 │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│ 8. 等待交易確認                       │
│    ⏳ 正在處理交易...                 │
│    交易哈希：0x...                   │
│    ↓                                 │
│    等待區塊鏈確認...                 │
│    (通常 15-30 秒)                   │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│ 9. 記錄鑄造結果                       │
│    ↓                                 │
│    • 記錄到 Firestore                │
│    • 更新 currentSupply              │
│    • 標記 email 為已鑄造             │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│ ✅ 鑄造成功！                         │
│    • 顯示成功訊息                     │
│    • 顯示 Token ID                   │
│    • 提供區塊鏈瀏覽器連結             │
│    • [查看 NFT 詳情]                 │
│    • [返回個人頁面]                   │
└─────────────────────────────────────┘
```

## 訪客查看 NFT 詳情流程

```
開始
  │
  ▼
┌─────────────────────────────────────┐
│ 1. 獲得 NFT 連結                     │
│    方式：                            │
│    • 從管理員頁面點擊                 │
│    • 從用戶頁面點擊                   │
│    • 直接輸入 URL                    │
│    • 別人分享連結                     │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│ 2. 訪問 NFT 公開頁面                 │
│    /nft/[campaignId]                 │
│    (無需登入)                         │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│ 3. 查看 NFT 活動資訊                 │
│    ↓                                 │
│    • NFT 圖片（大圖展示）             │
│    • 活動名稱和描述                   │
│    • 活動狀態                         │
│    • 區塊鏈網路                       │
│    • 智能合約地址                     │
│    • 鑄造進度                         │
│    • 截止日期                         │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│ 4. 查看鑄造記錄                       │
│    ↓                                 │
│    鑄造記錄表格：                     │
│    • Token ID                        │
│    • 鑄造用戶                         │
│    • 鑄造時間                         │
│    • 交易哈希（可點擊查看）           │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│ 5. 互動功能                          │
│    ↓                                 │
│    可以：                            │
│    • 點擊合約地址查看 Etherscan      │
│    • 點擊交易哈希查看詳情             │
│    • 分享頁面連結給其他人             │
└─────────────────────────────────────┘
```

## 資料流程圖

```
┌──────────────────────────────────────────────────────────────┐
│                         前端 (Next.js)                         │
├────────────┬───────────────────┬────────────────┬────────────┤
│            │                   │                │            │
│  管理員頁面  │    用戶頁面        │   鑄造頁面      │  公開頁面   │
│            │                   │                │            │
└─────┬──────┴────────┬──────────┴────────┬───────┴──────┬─────┘
      │               │                   │              │
      │               │                   │              │
      ▼               ▼                   ▼              ▼
┌─────────────┐ ┌─────────────┐   ┌─────────────┐ ┌──────────┐
│  Admin API  │ │  User API   │   │  User API   │ │Public API│
└──────┬──────┘ └──────┬──────┘   └──────┬──────┘ └────┬─────┘
       │               │                  │             │
       │               │                  │             │
       ▼               ▼                  ▼             ▼
┌────────────────────────────────────────────────────────────┐
│                    Firebase Firestore                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │nft-campaigns │  │  nft-mints   │  │    users     │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└────────────────────────────────────────────────────────────┘
       │                                      │
       │                                      │
       ▼                                      ▼
┌──────────────┐                    ┌──────────────────┐
│ IPFS (Pinata)│                    │  Smart Contract  │
│              │                    │  (Ethereum)      │
│ • 圖片        │                    │                  │
│ • Metadata   │                    │ • ERC-721        │
└──────────────┘                    │ • Merkle Tree    │
                                    │ • Mint Logic     │
                                    └──────────────────┘
```

## 權限檢查流程

```
用戶請求頁面/API
       │
       ▼
┌─────────────────────────────────────┐
│ 檢查頁面/API 權限需求                 │
└──────────┬──────────────────────────┘
           │
           ▼
    ┌──────┴───────┐
    │              │
    ▼              ▼
需要認證？      不需要
    │              │
    ▼              ▼
檢查用戶登入   ✅ 直接允許
    │           (公開頁面)
    ▼
已登入？
    │
    ├─ 是 ─────────┐
    │              │
    ▼              ▼
需要管理員？   ✅ 允許訪問
    │           (用戶頁面)
    ▼
檢查 permissions
    │
    ├─ super_admin? ─┐
    │                │
    ▼                ▼
❌ 拒絕訪問     ✅ 允許訪問
   Forbidden      (管理員頁面)
```

## 鑄造驗證流程

```
用戶點擊「鑄造 NFT」
       │
       ▼
┌─────────────────────────────────────┐
│ 1. 前端驗證                          │
│    • 檢查錢包連接                     │
│    • 檢查網路正確                     │
│    • 檢查活動狀態                     │
└──────────┬──────────────────────────┘
           │
           ▼
┌─────────────────────────────────────┐
│ 2. 獲取 Merkle Proof                │
│    從 Firestore 取得用戶的 proof     │
└──────────┬──────────────────────────┘
           │
           ▼
┌─────────────────────────────────────┐
│ 3. 呼叫智能合約                       │
│    mint(emailHash, merkleProof)      │
└──────────┬──────────────────────────┘
           │
           ▼
┌─────────────────────────────────────┐
│ 4. 智能合約驗證                       │
│    • 檢查 Merkle Proof               │
│    • 檢查是否已鑄造                   │
│    • 檢查鑄造是否啟用                 │
└──────────┬──────────────────────────┘
           │
           ▼
    ┌──────┴───────┐
    │              │
    ▼              ▼
驗證通過        驗證失敗
    │              │
    ▼              ▼
鑄造 NFT       ❌ 交易回退
    │           拋出錯誤
    ▼
✅ 鑄造成功
    │
    ▼
記錄到 Firestore
```

## 系統互動序列圖

```
管理員         前端         Admin API    Firestore    IPFS    Contract
  │             │              │            │          │         │
  │─建立活動────▶│              │            │          │         │
  │             │─創建請求────▶│            │          │         │
  │             │              │─儲存──────▶│          │         │
  │             │◀─活動ID──────│            │          │         │
  │◀─顯示活動───│              │            │          │         │
  │             │              │            │          │         │
  │─自動設置────▶│              │            │          │         │
  │             │─上傳圖片────────────────────────────▶│         │
  │             │◀─Base URI───────────────────────────│         │
  │             │              │            │          │         │
  │─連接錢包────▶│              │            │          │         │
  │◀─請求授權───│              │            │          │         │
  │─授權────────▶│              │            │          │         │
  │             │              │            │          │         │
  │             │─部署合約────────────────────────────────────────▶│
  │             │◀─合約地址───────────────────────────────────────│
  │             │              │            │          │         │
  │             │─設置Root────────────────────────────────────────▶│
  │             │◀─確認───────────────────────────────────────────│
  │             │              │            │          │         │
  │             │─啟用鑄造────────────────────────────────────────▶│
  │             │◀─確認───────────────────────────────────────────│
  │             │              │            │          │         │
  │             │─更新狀態────▶│            │          │         │
  │             │              │─儲存──────▶│          │         │
  │◀─完成───────│              │            │          │         │
```

---

**文檔版本**：v2.0  
**最後更新**：2025-11-09  
**圖表類型**：ASCII 流程圖

